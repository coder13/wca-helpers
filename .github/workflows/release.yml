name: Release

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build package
        run: npm run build

      - name: Read package version
        id: pkg
        run: echo "version=$(node -p \"require('./package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Check published version
        id: published
        run: |
          PUBLISHED=$(npm view @wca/helpers version || echo "none")
          echo "version=$PUBLISHED" >> "$GITHUB_OUTPUT"

      - name: Create tag from package version
        id: create_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.pkg.outputs.version }}';
            const tag = `v${version}`;
            const { owner, repo } = context.repo;

            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${tag}` });
              core.info(`Tag ${tag} already exists, skipping creation.`);
              core.setOutput('created', 'false');
              return;
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/tags/${tag}`,
              sha: context.sha,
            });
            core.info(`Created tag ${tag}.`);
            core.setOutput('created', 'true');

      - name: Publish to npm
        if: steps.pkg.outputs.version != steps.published.outputs.version
        run: npm publish --access public --provenance

      - name: Create GitHub release
        if: steps.create_tag.outputs.created == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.pkg.outputs.version }}
          generate_release_notes: true
